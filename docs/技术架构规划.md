# 户外运动管理平台技术架构规划书

## 1. 项目背景与目标
基于《户外运动管理平台战略规划方案》，本项目旨在构建一个垂直于户外领域的社交与服务平台。核心连接“大学生”与“专业人士”两大群体，提供活动发布、报名、线路查询、社群互动等服务。

## 2. 技术选型策略

### 2.1 总体架构原则
- **移动优先**：C端用户主要通过微信小程序访问。
- **地理信息核心**：户外线路涉及复杂的轨迹数据（GPX）、坐标计算，数据库需支持强大的GIS功能。
- **高并发预留**：考虑到高校活动可能出现的瞬时流量（如热门活动抢票），架构需具备水平扩展能力。
- **模块化开发**：前后端分离，后端采用微服务就绪的单体架构（Modular Monolith）。

### 2.2 技术栈详细选型

| 模块 | 选型 | 理由 |
| :--- | :--- | :--- |
| **用户端 (小程序)** | **Taro + React + TypeScript** | 1. **多端复用**：Taro 优秀的跨端能力，未来可低成本迁移至 App 或 H5。<br>2. **React 生态**：利用 React 强大的组件化能力和 Hooks 逻辑复用。<br>3. **类型安全**：TypeScript 保证大型项目的可维护性。 |
| **UI 组件库** | **NutUI-React** (京东) | 风格现代，专为移动端电商/业务场景设计，组件丰富（日历、SKU、支付弹窗等）。 |
| **后端服务** | **NestJS** (Node.js) | 1. **企业级框架**：提供完整的模块化、依赖注入、守卫、拦截器机制。<br>2. **TypeScript 原生**：与前端共享类型定义（DTO/Interface）。<br>3. **生态丰富**：官方支持 TypeORM/Prisma、Swagger、Microservices。 |
| **数据库** | **PostgreSQL + PostGIS** | **核心决策**：户外平台的核心资产是“线路库”。PostGIS 是目前开源界最强的地理信息系统插件，原生支持 GPX 数据解析、距离计算、围栏检测等，远优于 MySQL。 |
| **ORM 框架** | **Prisma** | 类型安全，开发体验极佳，能够自动生成类型定义。 |
| **缓存服务** | **Redis** | 用于处理 Session、验证码、热门活动缓存、分布式锁（防止超卖）。 |
| **对象存储** | **阿里云 OSS / 腾讯云 COS** | 存储海量活动照片、视频、用户头像及 GPX 文件。 |
| **地图服务** | **腾讯地图 API** | 微信小程序原生支持，定位精准，路径规划能力强。 |

## 3. 系统架构设计

### 3.1 逻辑架构图
```mermaid
graph TD
    Client[微信小程序 (C端)] --> LB[负载均衡 (Nginx/SLB)]
    Admin[管理后台 (Web)] --> LB
    
    LB --> API_Gateway[API 网关 / NestJS Server]
    
    subgraph "后端服务 (NestJS)"
        Auth[认证模块]
        User[用户中心]
        Activity[活动模块]
        Route[线路/GIS模块]
        Order[订单/支付模块]
        Social[社群/圈子模块]
    end
    
    API_Gateway --> Auth
    API_Gateway --> User
    API_Gateway --> Activity
    API_Gateway --> Route
    API_Gateway --> Order
    API_Gateway --> Social
    
    Route --> PostGIS[(PostgreSQL + PostGIS)]
    User --> DB[(PostgreSQL)]
    Activity --> DB
    
    Auth --> Redis[(Redis Cache)]
    Activity --> Redis
    
    Route --> OSS[对象存储 (OSS/COS)]
    Activity --> OSS
```

### 3.2 核心数据模型 (简述)

1.  **User (用户)**
    *   `id`: UUID
    *   `open_id`: 微信OpenID
    *   `role`: STUDENT | PRO | ADMIN
    *   `identity_proof`: 认证材料 (JSON)

2.  **Activity (活动)**
    *   `id`: UUID
    *   `title`: 标题
    *   `start_time`: 开始时间
    *   `route_id`: 关联线路ID
    *   `price_config`: 费用结构 (JSON)
    *   `max_participants`: 最大人数

3.  **Route (线路)**
    *   `id`: UUID
    *   `name`: 线路名
    *   `geometry`: Geography (LineString, PostGIS字段)
    *   `difficulty`: 难度等级
    *   `gpx_url`: GPX文件地址

4.  **Order (订单)**
    *   `id`: UUID
    *   `user_id`: 用户ID
    *   `activity_id`: 活动ID
    *   `status`: PENDING | PAID | CANCELLED | COMPLETED

## 4. 部署架构
- **开发环境**：本地 Docker Compose (Postgres, Redis)。
- **生产环境**：云服务器 (ECS/CVM) + 容器化部署 (Docker)。
- **CI/CD**：GitHub Actions 或 GitLab CI 自动构建部署。

## 5. 安全策略
- **数据安全**：所有敏感数据（手机号、身份证）加密存储。
- **接口安全**：JWT 认证，HTTPS 传输，请求限流 (Rate Limiting)。
- **支付安全**：严格校验微信支付回调签名，使用分布式锁处理并发支付。
