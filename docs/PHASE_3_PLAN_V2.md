# æˆ·å¤–è¿åŠ¨ç®¡ç†å¹³å° Phase 3 (ç¤¾åŒºä¸ç¤¾äº¤) ä¼˜åŒ–ç‰ˆå¼€å‘è®¡åˆ’ V2.0

**ç‰ˆæœ¬**: 2.0 (ä¼˜åŒ–ç‰ˆ)
**æ›´æ–°æ—¥æœŸ**: 2025-11-29
**å‘¨æœŸ**: Week 7-9 (3å‘¨)
**ç›®æ ‡**: æ„å»º"åœˆå±‚åŒ–æˆ·å¤–ç”Ÿæ´»æ–¹å¼"ç¤¾åŒºï¼Œå®ç°ç”¨æˆ·å¼ºè¿æ¥ï¼Œæå‡å¹³å°ç•™å­˜ç‡ä¸æ´»è·ƒåº¦

---

## 1. æ ¸å¿ƒåŠŸèƒ½æ¨¡å— (é‡æ–°è§„åˆ’)

### 1.1 å¸–å­/åŠ¨æ€ç³»ç»Ÿ (Posts)

**åŠŸèƒ½æè¿°**:
- ç”¨æˆ·å‘å¸ƒå›¾æ–‡åŠ¨æ€ (ç±»ä¼¼å°çº¢ä¹¦/æœ‹å‹åœˆ)
- æ”¯æŒå…³è”å·²å‚ä¸çš„æ´»åŠ¨ã€çº¿è·¯ã€è¯é¢˜æ ‡ç­¾
- äº’åŠ¨: ç‚¹èµã€è¯„è®ºã€æ”¶è—ã€åˆ†äº«

**æŠ€æœ¯è¦ç‚¹**:
- å¤šå›¾ä¸Šä¼  (æœ€å¤š9å¼ )
- å›¾ç‰‡å‹ç¼©ä¸ CDN åˆ†å‘
- è¯„è®ºæ”¯æŒäºŒçº§åµŒå¥— (å›å¤è¯„è®º)

### 1.2 æ´»åŠ¨ç›¸å†Œ (Activity Albums) ğŸ†•

**åŠŸèƒ½æè¿°**:
- æ´»åŠ¨å®Œæˆå (`status = COMPLETED`)ï¼Œå‚ä¸è€…å¯ä¸Šä¼ ç…§ç‰‡åˆ°æ´»åŠ¨ç›¸å†Œ
- ç›¸å†Œå½’å±äºæ´»åŠ¨ï¼Œæ‰€æœ‰å‚ä¸è€…å¯æŸ¥çœ‹
- ç²¾é€‰ç…§ç‰‡å¯ç½®é¡¶å±•ç¤º

**ä¸šåŠ¡è§„åˆ™**:
- ä»… `CHECKED_IN` çŠ¶æ€çš„æŠ¥åè€…å¯ä¸Šä¼ 
- æ´»åŠ¨ç»“æŸå 7 å¤©å†…å¯ä¸Šä¼ 
- æ¯äººæ¯æ´»åŠ¨æœ€å¤šä¸Šä¼  20 å¼ 

### 1.3 åœˆå­ç³»ç»Ÿ (Circles)

**åŠŸèƒ½æè¿°**:
- åŸºäºèŒä¸šçš„åœˆå­: åŒ»ç”Ÿæˆ·å¤–ç¾¤ã€å¾‹å¸ˆéª‘è¡Œé˜Ÿã€æ•™å¸ˆå¾’æ­¥ç»„
- åŸºäºå…´è¶£çš„åœˆå­: æ‘„å½±å…šã€è£…å¤‡æ§ã€äº²å­æ¸¸
- åœˆå­å†…ä¸“å±è®¨è®ºåŒºå’Œæ´»åŠ¨æ¨è

**ä¸ä¿±ä¹éƒ¨çš„å…³ç³»**:
- ä¿±ä¹éƒ¨ (Club) = æ´»åŠ¨ç»„ç»‡æ–¹ (Bç«¯)
- åœˆå­ (Circle) = ç”¨æˆ·å…´è¶£ç¤¾ç¾¤ (Cç«¯)
- ä¿±ä¹éƒ¨å¯åˆ›å»ºå®˜æ–¹åœˆå­ (`isOfficial = true`)

### 1.4 ç”¨æˆ·å…³ç³» (Social Graph)

**åŠŸèƒ½æè¿°**:
- å…³æ³¨/ç²‰ä¸æœºåˆ¶
- äº’ç›¸å…³æ³¨è‡ªåŠ¨æˆä¸ºå¥½å‹
- æŸ¥çœ‹å…³æ³¨åˆ—è¡¨ã€ç²‰ä¸åˆ—è¡¨

### 1.5 æˆå°±ä½“ç³» (Achievements)

**å‹‹ç« å®šä¹‰** (åŸºäºæˆ˜ç•¥è§„åˆ’):

| å‹‹ç« åç§° | å›¾æ ‡ | è·å–æ¡ä»¶ | ç±»å‹ |
|:---|:---|:---|:---|
| åˆæ¬¡è¿œè¶³ | ğŸ¥¾ | å®Œæˆé¦–æ¬¡æ´»åŠ¨ | é‡Œç¨‹ç¢‘ |
| æ­¥é“è¡Œè€… | ğŸš¶ | ç´¯è®¡å®Œæˆ 10 æ¬¡å¾’æ­¥æ´»åŠ¨ | ç´¯è®¡å‹ |
| é«˜åŸå¾æœè€… | ğŸ”ï¸ | å®Œæˆ 5 æ¬¡æµ·æ‹” 4000m+ æ´»åŠ¨ | æŒ‘æˆ˜å‹ |
| é›¨ä¸­æ¼«æ­¥ | ğŸŒ§ï¸ | åœ¨é›¨å¤©å®Œæˆæˆ·å¤–æ´»åŠ¨ | ç‰¹æ®Šå‹ |
| ç¤¾äº¤è¾¾äºº | ğŸ’¬ | å‘å¸ƒ 20 æ¡åŠ¨æ€ | äº’åŠ¨å‹ |
| æ¢è·¯å…ˆé”‹ | ğŸ—ºï¸ | ä¸Šä¼  5 æ¡ä¼˜è´¨çº¿è·¯ | è´¡çŒ®å‹ |
| äººæ°”é¢†é˜Ÿ | â­ | é¢†é˜Ÿè¯„åˆ† 4.8+ ä¸”å¸¦é˜Ÿ 10 æ¬¡ | é¢†é˜Ÿä¸“å± |

**è§¦å‘æœºåˆ¶**:
- ç›‘å¬ `Enrollment.status` å˜æ›´ä¸º `CHECKED_IN`
- ç›‘å¬ `Activity.status` å˜æ›´ä¸º `COMPLETED`
- å®šæ—¶ä»»åŠ¡æ£€æŸ¥ç´¯è®¡å‹æˆå°±

### 1.6 è´¡çŒ®è€…æ’è¡Œæ¦œ ğŸ†•

**åŠŸèƒ½æè¿°**:
- çº¿è·¯è´¡çŒ®æ’è¡Œ (ä¸Šä¼ çº¿è·¯æ•°é‡)
- æœ¬æœˆæ´»è·ƒæ’è¡Œ (å‘å¸–æ•° + äº’åŠ¨æ•°)
- åœˆå­æ´»è·ƒæ’è¡Œ

### 1.7 ä¸ªäººä¸»é¡µå‡çº§

**å±•ç¤ºå†…å®¹**:
- æˆ·å¤–å±¥å†: å‚ä¸æ´»åŠ¨æ¬¡æ•°ã€æ€»é‡Œç¨‹ã€ç´¯è®¡çˆ¬å‡
- è¶³è¿¹åœ°å›¾: åŸºäºå‚ä¸æ´»åŠ¨çš„çº¿è·¯èšåˆ
- å‹‹ç« å¢™: å·²è·å¾—çš„æˆå°±å±•ç¤º
- åŠ¨æ€åˆ—è¡¨: ç”¨æˆ·å‘å¸ƒçš„æ‰€æœ‰å¸–å­

---

## 2. æ•°æ®åº“è®¾è®¡ (Prisma Schema)

### 2.1 æ–°å¢æ¨¡å‹

```prisma
// ==================== å¸–å­ç›¸å…³ ====================
model Post {
  id          String      @id @default(uuid())
  userId      String
  content     String
  activityId  String?     // å…³è”æ´»åŠ¨ (å¯é€‰)
  routeId     String?     // å…³è”çº¿è·¯ (å¯é€‰)
  circleId    String?     // å‘å¸ƒåˆ°åœˆå­ (å¯é€‰)
  tags        String[]    // è¯é¢˜æ ‡ç­¾
  viewCount   Int         @default(0)
  isTop       Boolean     @default(false)  // ç½®é¡¶
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user        User        @relation(fields: [userId], references: [id])
  activity    Activity?   @relation(fields: [activityId], references: [id])
  route       Route?      @relation(fields: [routeId], references: [id])
  circle      Circle?     @relation(fields: [circleId], references: [id])
  images      PostImage[]
  comments    Comment[]
  likes       PostLike[]

  @@index([userId])
  @@index([circleId])
  @@index([createdAt])
}

model PostImage {
  id        String   @id @default(uuid())
  postId    String
  url       String
  width     Int?
  height    Int?
  sortOrder Int      @default(0)

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model PostLike {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([postId, userId])
}

// ==================== è¯„è®ºç›¸å…³ ====================
model Comment {
  id        String        @id @default(uuid())
  postId    String
  userId    String
  content   String
  parentId  String?       // å›å¤çš„è¯„è®ºID (äºŒçº§è¯„è®º)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  post      Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id])
  parent    Comment?      @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[]     @relation("CommentReplies")
  likes     CommentLike[]

  @@index([postId])
}

model CommentLike {
  id        String   @id @default(uuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())

  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([commentId, userId])
}

// ==================== ç”¨æˆ·å…³ç³» ====================
model Follow {
  id          String   @id @default(uuid())
  followerId  String   // å…³æ³¨è€…
  followingId String   // è¢«å…³æ³¨è€…
  createdAt   DateTime @default(now())

  follower    User     @relation("Followers", fields: [followerId], references: [id])
  following   User     @relation("Following", fields: [followingId], references: [id])

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ==================== åœˆå­ç›¸å…³ ====================
model Circle {
  id          String         @id @default(uuid())
  name        String
  description String?
  icon        String?
  coverUrl    String?
  category    CircleCategory @default(INTEREST)
  creatorId   String
  clubId      String?        // å…³è”ä¿±ä¹éƒ¨ (å®˜æ–¹åœˆå­)
  isOfficial  Boolean        @default(false)
  memberCount Int            @default(0)
  postCount   Int            @default(0)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  creator     User           @relation("CircleCreator", fields: [creatorId], references: [id])
  club        Club?          @relation(fields: [clubId], references: [id])
  members     CircleMember[]
  posts       Post[]

  @@index([category])
}

model CircleMember {
  id       String     @id @default(uuid())
  circleId String
  userId   String
  role     CircleRole @default(MEMBER)
  joinedAt DateTime   @default(now())

  circle   Circle     @relation(fields: [circleId], references: [id], onDelete: Cascade)
  user     User       @relation(fields: [userId], references: [id])

  @@unique([circleId, userId])
}

// ==================== æ´»åŠ¨ç›¸å†Œ (æ–°å¢) ====================
model ActivityPhoto {
  id          String   @id @default(uuid())
  activityId  String
  userId      String
  url         String
  description String?
  isFeatured  Boolean  @default(false)  // ç²¾é€‰
  createdAt   DateTime @default(now())

  activity    Activity @relation(fields: [activityId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([activityId])
}

// ==================== æˆå°±ç³»ç»Ÿ ====================
model Badge {
  id          String      @id @default(uuid())
  name        String      @unique
  icon        String
  description String
  category    BadgeCategory
  criteria    Json        // è§¦å‘æ¡ä»¶ (JSONæ ¼å¼å­˜å‚¨)
  sortOrder   Int         @default(0)

  userBadges  UserBadge[]
}

model UserBadge {
  id        String   @id @default(uuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  badge     Badge    @relation(fields: [badgeId], references: [id])

  @@unique([userId, badgeId])
}

// ==================== é€šçŸ¥ç³»ç»Ÿ ====================
model Notification {
  id         String           @id @default(uuid())
  userId     String           // æ¥æ”¶è€…
  type       NotificationType
  title      String
  content    String?
  targetId   String?          // ç›®æ ‡å®ä½“ID
  targetType String?          // ç›®æ ‡å®ä½“ç±»å‹
  isRead     Boolean          @default(false)
  createdAt  DateTime         @default(now())

  user       User             @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
  @@index([createdAt])
}

// ==================== æšä¸¾å®šä¹‰ ====================
enum CircleCategory {
  PROFESSION  // èŒä¸šåœˆ
  INTEREST    // å…´è¶£åœˆ
  REGION      // åœ°åŒºåœˆ
  ACTIVITY    // æ´»åŠ¨åœˆ
}

enum CircleRole {
  OWNER
  ADMIN
  MEMBER
}

enum BadgeCategory {
  MILESTONE   // é‡Œç¨‹ç¢‘
  CUMULATIVE  // ç´¯è®¡å‹
  CHALLENGE   // æŒ‘æˆ˜å‹
  SPECIAL     // ç‰¹æ®Šå‹
  SOCIAL      // ç¤¾äº¤å‹
  CONTRIBUTION // è´¡çŒ®å‹
  LEADER      // é¢†é˜Ÿä¸“å±
}

enum NotificationType {
  LIKE        // ç‚¹èµ
  COMMENT     // è¯„è®º
  FOLLOW      // å…³æ³¨
  BADGE       // è·å¾—å‹‹ç« 
  ACTIVITY    // æ´»åŠ¨ç›¸å…³
  SYSTEM      // ç³»ç»Ÿé€šçŸ¥
}
```

### 2.2 éœ€è¦æ›´æ–°çš„ç°æœ‰æ¨¡å‹

```prisma
// User æ¨¡å‹æ·»åŠ å…³ç³»
model User {
  // ... ç°æœ‰å­—æ®µ ...

  // æ–°å¢å…³ç³»
  posts          Post[]
  postLikes      PostLike[]
  commentLikes   CommentLike[]
  followers      Follow[]       @relation("Following")
  following      Follow[]       @relation("Followers")
  createdCircles Circle[]       @relation("CircleCreator")
  circleMembers  CircleMember[]
  activityPhotos ActivityPhoto[]
  userBadges     UserBadge[]
  notifications  Notification[]
}

// Activity æ¨¡å‹æ·»åŠ å…³ç³»
model Activity {
  // ... ç°æœ‰å­—æ®µ ...

  // æ–°å¢å…³ç³»
  posts   Post[]
  photos  ActivityPhoto[]
}

// Route æ¨¡å‹æ·»åŠ å…³ç³»
model Route {
  // ... ç°æœ‰å­—æ®µ ...
  creatorId String?  // çº¿è·¯è´¡çŒ®è€… (æ–°å¢)

  // æ–°å¢å…³ç³»
  posts   Post[]
  creator User?     @relation("RouteCreator", fields: [creatorId], references: [id])
}

// Club æ¨¡å‹æ·»åŠ å…³ç³»
model Club {
  // ... ç°æœ‰å­—æ®µ ...

  // æ–°å¢å…³ç³»
  circles Circle[]
}
```

---

## 3. åç«¯å¼€å‘è®¡åˆ’ (Backend)

### 3.1 æ¨¡å—ç»“æ„

```
backend/src/
â”œâ”€â”€ social/
â”‚   â”œâ”€â”€ social.module.ts
â”‚   â”œâ”€â”€ post/
â”‚   â”‚   â”œâ”€â”€ post.controller.ts
â”‚   â”‚   â”œâ”€â”€ post.service.ts
â”‚   â”‚   â””â”€â”€ dto/
â”‚   â”œâ”€â”€ comment/
â”‚   â”‚   â”œâ”€â”€ comment.controller.ts
â”‚   â”‚   â”œâ”€â”€ comment.service.ts
â”‚   â”‚   â””â”€â”€ dto/
â”‚   â”œâ”€â”€ follow/
â”‚   â”‚   â”œâ”€â”€ follow.controller.ts
â”‚   â”‚   â”œâ”€â”€ follow.service.ts
â”‚   â”‚   â””â”€â”€ dto/
â”‚   â””â”€â”€ feed/
â”‚       â”œâ”€â”€ feed.controller.ts
â”‚       â””â”€â”€ feed.service.ts
â”œâ”€â”€ circle/
â”‚   â”œâ”€â”€ circle.module.ts
â”‚   â”œâ”€â”€ circle.controller.ts
â”‚   â”œâ”€â”€ circle.service.ts
â”‚   â””â”€â”€ dto/
â”œâ”€â”€ achievement/
â”‚   â”œâ”€â”€ achievement.module.ts
â”‚   â”œâ”€â”€ badge.controller.ts
â”‚   â”œâ”€â”€ badge.service.ts
â”‚   â””â”€â”€ achievement.listener.ts  // äº‹ä»¶ç›‘å¬å™¨
â”œâ”€â”€ album/
â”‚   â”œâ”€â”€ album.module.ts
â”‚   â”œâ”€â”€ album.controller.ts
â”‚   â””â”€â”€ album.service.ts
â””â”€â”€ notification/
    â”œâ”€â”€ notification.module.ts
    â”œâ”€â”€ notification.controller.ts
    â””â”€â”€ notification.service.ts
```

### 3.2 API ç«¯ç‚¹è®¾è®¡

#### å¸–å­æ¨¡å— `/posts`
| Method | Endpoint | æè¿° |
|:---|:---|:---|
| POST | /posts | åˆ›å»ºå¸–å­ |
| GET | /posts | è·å–å¸–å­åˆ—è¡¨ (åˆ†é¡µ/ç­›é€‰) |
| GET | /posts/:id | è·å–å¸–å­è¯¦æƒ… |
| DELETE | /posts/:id | åˆ é™¤å¸–å­ |
| POST | /posts/:id/like | ç‚¹èµå¸–å­ |
| DELETE | /posts/:id/like | å–æ¶ˆç‚¹èµ |

#### è¯„è®ºæ¨¡å— `/comments`
| Method | Endpoint | æè¿° |
|:---|:---|:---|
| POST | /posts/:postId/comments | åˆ›å»ºè¯„è®º |
| GET | /posts/:postId/comments | è·å–è¯„è®ºåˆ—è¡¨ |
| DELETE | /comments/:id | åˆ é™¤è¯„è®º |
| POST | /comments/:id/like | ç‚¹èµè¯„è®º |

#### å…³æ³¨æ¨¡å— `/users`
| Method | Endpoint | æè¿° |
|:---|:---|:---|
| POST | /users/:id/follow | å…³æ³¨ç”¨æˆ· |
| DELETE | /users/:id/follow | å–æ¶ˆå…³æ³¨ |
| GET | /users/:id/followers | è·å–ç²‰ä¸åˆ—è¡¨ |
| GET | /users/:id/following | è·å–å…³æ³¨åˆ—è¡¨ |

#### åœˆå­æ¨¡å— `/circles`
| Method | Endpoint | æè¿° |
|:---|:---|:---|
| POST | /circles | åˆ›å»ºåœˆå­ |
| GET | /circles | è·å–åœˆå­åˆ—è¡¨ |
| GET | /circles/:id | è·å–åœˆå­è¯¦æƒ… |
| POST | /circles/:id/join | åŠ å…¥åœˆå­ |
| DELETE | /circles/:id/leave | é€€å‡ºåœˆå­ |
| GET | /circles/:id/posts | è·å–åœˆå­å¸–å­ |

#### æ´»åŠ¨ç›¸å†Œ `/activities/:id/photos`
| Method | Endpoint | æè¿° |
|:---|:---|:---|
| POST | /activities/:id/photos | ä¸Šä¼ ç…§ç‰‡ |
| GET | /activities/:id/photos | è·å–ç›¸å†Œ |
| DELETE | /activities/:id/photos/:photoId | åˆ é™¤ç…§ç‰‡ |
| PUT | /activities/:id/photos/:photoId/feature | è®¾ä¸ºç²¾é€‰ |

#### æˆå°±ç³»ç»Ÿ `/achievements`
| Method | Endpoint | æè¿° |
|:---|:---|:---|
| GET | /badges | è·å–æ‰€æœ‰å‹‹ç« å®šä¹‰ |
| GET | /users/:id/badges | è·å–ç”¨æˆ·å‹‹ç«  |
| GET | /leaderboard/routes | çº¿è·¯è´¡çŒ®æ’è¡Œ |
| GET | /leaderboard/active | æ´»è·ƒåº¦æ’è¡Œ |

#### Feed æµ `/feed`
| Method | Endpoint | æè¿° |
|:---|:---|:---|
| GET | /feed | è·å–ä¸ªäºº Feed (å…³æ³¨çš„äºº) |
| GET | /feed/recommend | æ¨è Feed |
| GET | /feed/circle/:id | åœˆå­ Feed |

#### é€šçŸ¥ `/notifications`
| Method | Endpoint | æè¿° |
|:---|:---|:---|
| GET | /notifications | è·å–é€šçŸ¥åˆ—è¡¨ |
| PUT | /notifications/:id/read | æ ‡è®°å·²è¯» |
| PUT | /notifications/read-all | å…¨éƒ¨å·²è¯» |
| GET | /notifications/unread-count | æœªè¯»æ•°é‡ |

---

## 4. å‰ç«¯å¼€å‘è®¡åˆ’ (Frontend)

### 4.1 é¡µé¢ç»“æ„

```
frontend/src/pages/
â”œâ”€â”€ community/
â”‚   â”œâ”€â”€ index.tsx          # ç¤¾åŒºé¦–é¡µ (Feedæµ)
â”‚   â””â”€â”€ search.tsx         # æœç´¢å¸–å­/åœˆå­
â”œâ”€â”€ post/
â”‚   â”œâ”€â”€ publish.tsx        # å‘å¸ƒå¸–å­
â”‚   â””â”€â”€ detail.tsx         # å¸–å­è¯¦æƒ…
â”œâ”€â”€ circle/
â”‚   â”œâ”€â”€ index.tsx          # åœˆå­å¹¿åœº
â”‚   â”œâ”€â”€ detail.tsx         # åœˆå­è¯¦æƒ…
â”‚   â””â”€â”€ create.tsx         # åˆ›å»ºåœˆå­
â”œâ”€â”€ user/
â”‚   â””â”€â”€ [id].tsx           # ä»–äººä¸»é¡µ
â”œâ”€â”€ album/
â”‚   â””â”€â”€ [activityId].tsx   # æ´»åŠ¨ç›¸å†Œ
â”œâ”€â”€ leaderboard/
â”‚   â””â”€â”€ index.tsx          # æ’è¡Œæ¦œ
â””â”€â”€ profile/
    â”œâ”€â”€ index.tsx          # ä¸ªäººä¸­å¿ƒ (å‡çº§)
    â”œâ”€â”€ badges.tsx         # æˆ‘çš„å‹‹ç« 
    â”œâ”€â”€ footprint.tsx      # è¶³è¿¹åœ°å›¾
    â””â”€â”€ followers.tsx      # ç²‰ä¸/å…³æ³¨
```

### 4.2 æ ¸å¿ƒç»„ä»¶

```
frontend/src/components/
â”œâ”€â”€ social/
â”‚   â”œâ”€â”€ PostCard.tsx       # å¸–å­å¡ç‰‡
â”‚   â”œâ”€â”€ PostList.tsx       # å¸–å­åˆ—è¡¨ (è™šæ‹Ÿæ»šåŠ¨)
â”‚   â”œâ”€â”€ CommentList.tsx    # è¯„è®ºåˆ—è¡¨
â”‚   â”œâ”€â”€ CommentInput.tsx   # è¯„è®ºè¾“å…¥æ¡†
â”‚   â”œâ”€â”€ LikeButton.tsx     # ç‚¹èµæŒ‰é’® (å«åŠ¨ç”»)
â”‚   â””â”€â”€ SharePanel.tsx     # åˆ†äº«é¢æ¿
â”œâ”€â”€ circle/
â”‚   â”œâ”€â”€ CircleCard.tsx     # åœˆå­å¡ç‰‡
â”‚   â””â”€â”€ CircleHeader.tsx   # åœˆå­å¤´éƒ¨ä¿¡æ¯
â”œâ”€â”€ user/
â”‚   â”œâ”€â”€ UserCard.tsx       # ç”¨æˆ·å¡ç‰‡ (å¤´åƒ+æ˜µç§°+å…³æ³¨æŒ‰é’®)
â”‚   â”œâ”€â”€ BadgeWall.tsx      # å‹‹ç« å¢™
â”‚   â”œâ”€â”€ FootprintMap.tsx   # è¶³è¿¹åœ°å›¾
â”‚   â””â”€â”€ StatsPanel.tsx     # ç»Ÿè®¡é¢æ¿
â”œâ”€â”€ album/
â”‚   â”œâ”€â”€ PhotoGrid.tsx      # ç…§ç‰‡ç½‘æ ¼
â”‚   â””â”€â”€ PhotoUploader.tsx  # å¤šå›¾ä¸Šä¼ 
â””â”€â”€ notification/
    â””â”€â”€ NotificationList.tsx
```

---

## 5. å¼€å‘æ’æœŸ (3å‘¨)

### Week 7: å¸–å­ä¸äº’åŠ¨ (Phase 3.1)

| ä»»åŠ¡ID | ä»»åŠ¡ | ä¼˜å…ˆçº§ | ä¼°æ—¶ |
|:---|:---|:---|:---|
| DB-07 | è¿ç§»æ•°æ®åº“ (Post, Comment, Like, Follow) | P0 | 2h |
| BE-08 | å®ç° PostService (CRUD + ç‚¹èµ) | P0 | 4h |
| BE-09 | å®ç° CommentService (å«åµŒå¥—å›å¤) | P0 | 3h |
| BE-10 | å®ç° FollowService | P0 | 2h |
| BE-11 | å®ç° FeedService (Pullæ¨¡å¼) | P1 | 3h |
| FE-11 | å¼€å‘ PostCard / PostList ç»„ä»¶ | P0 | 4h |
| FE-12 | å¼€å‘å‘å¸ƒå¸–å­é¡µé¢ (å«å¤šå›¾ä¸Šä¼ ) | P0 | 4h |
| FE-13 | å¼€å‘å¸–å­è¯¦æƒ…é¡µ (å«è¯„è®º) | P0 | 4h |
| FE-14 | å¼€å‘ç¤¾åŒºé¦–é¡µ (Feedæµ) | P0 | 3h |
| TEST-05 | PostService å•å…ƒæµ‹è¯• | P1 | 2h |

### Week 8: åœˆå­ä¸ç›¸å†Œ (Phase 3.2)

| ä»»åŠ¡ID | ä»»åŠ¡ | ä¼˜å…ˆçº§ | ä¼°æ—¶ |
|:---|:---|:---|:---|
| DB-08 | è¿ç§»æ•°æ®åº“ (Circle, CircleMember, ActivityPhoto) | P0 | 2h |
| BE-12 | å®ç° CircleService | P0 | 4h |
| BE-13 | å®ç° AlbumService (æ´»åŠ¨ç›¸å†Œ) | P0 | 3h |
| BE-14 | å®ç°ç”¨æˆ·å…³ç³»æŸ¥è¯¢ (ç²‰ä¸/å…³æ³¨åˆ—è¡¨) | P1 | 2h |
| FE-15 | å¼€å‘åœˆå­å¹¿åœºé¡µé¢ | P0 | 4h |
| FE-16 | å¼€å‘åœˆå­è¯¦æƒ…é¡µé¢ | P0 | 4h |
| FE-17 | å¼€å‘æ´»åŠ¨ç›¸å†Œé¡µé¢ | P0 | 4h |
| FE-18 | å‡çº§ä¸ªäººä¸­å¿ƒ (ç»Ÿè®¡é¢æ¿/å…³æ³¨æ•°) | P1 | 3h |
| FE-19 | å¼€å‘ä»–äººä¸»é¡µ | P1 | 3h |
| TEST-06 | CircleService å•å…ƒæµ‹è¯• | P1 | 2h |

### Week 9: æˆå°±ä¸é€šçŸ¥ (Phase 3.3)

| ä»»åŠ¡ID | ä»»åŠ¡ | ä¼˜å…ˆçº§ | ä¼°æ—¶ |
|:---|:---|:---|:---|
| DB-09 | è¿ç§»æ•°æ®åº“ (Badge, UserBadge, Notification) | P0 | 2h |
| BE-15 | åˆå§‹åŒ–å‹‹ç« æ•°æ® (Seed) | P0 | 2h |
| BE-16 | å®ç° AchievementService (å‹‹ç« å‘æ”¾) | P0 | 4h |
| BE-17 | å®ç° AchievementListener (äº‹ä»¶ç›‘å¬) | P0 | 3h |
| BE-18 | å®ç° NotificationService | P1 | 3h |
| BE-19 | å®ç°æ’è¡Œæ¦œæ¥å£ | P1 | 2h |
| FE-20 | å¼€å‘å‹‹ç« å¢™ç»„ä»¶ | P0 | 3h |
| FE-21 | å¼€å‘è¶³è¿¹åœ°å›¾ç»„ä»¶ | P1 | 4h |
| FE-22 | å¼€å‘æ’è¡Œæ¦œé¡µé¢ | P2 | 3h |
| FE-23 | å¼€å‘é€šçŸ¥åˆ—è¡¨é¡µé¢ | P1 | 3h |
| TEST-07 | E2Eæµ‹è¯•: å‘å¸–â†’ç‚¹èµâ†’è¯„è®ºæµç¨‹ | P0 | 3h |

---

## 6. æŠ€æœ¯æ¶æ„è¡¥å……

### 6.0 å†…å®¹å®‰å…¨ä¸èµ„æºç®¡ç† (Critical)

#### 6.0.1 æ•æ„Ÿè¯è¿‡æ»¤ (Content Moderation)

**åˆè§„è¦æ±‚**: å¾®ä¿¡å°ç¨‹åºå®¡æ ¸è¦æ±‚å¿…é¡»æ¥å…¥å†…å®¹å®‰å…¨æ£€æµ‹ï¼Œå¦åˆ™å¯èƒ½æ— æ³•é€šè¿‡å®¡æ ¸ã€‚

**å®ç°ç­–ç•¥**:

```typescript
// content-security.service.ts
@Injectable()
export class ContentSecurityService {
  // ç¯å¢ƒå¼€å…³ï¼šéå¾®ä¿¡ç¯å¢ƒä¸‹è·³è¿‡æ£€æµ‹
  private readonly enableWxCheck = process.env.ENABLE_WX_CONTENT_CHECK === 'true';

  async checkContent(content: string): Promise<ContentCheckResult> {
    // 1. æœ¬åœ°æ•æ„Ÿè¯åº“æ£€æµ‹ (å§‹ç»ˆæ‰§è¡Œ)
    const localResult = await this.localSensitiveWordCheck(content);
    if (!localResult.pass) {
      return localResult;
    }

    // 2. å¾®ä¿¡å†…å®¹å®‰å…¨ API (ä»…ç”Ÿäº§ç¯å¢ƒ)
    if (this.enableWxCheck) {
      return await this.wxMsgSecCheck(content);
    }

    return { pass: true };
  }

  // å¾®ä¿¡å°ç¨‹åº security.msgSecCheck æ¥å£
  private async wxMsgSecCheck(content: string): Promise<ContentCheckResult> {
    // è°ƒç”¨å¾®ä¿¡å†…å®¹å®‰å…¨æ¥å£
    // https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.msgSecCheck.html
  }
}
```

**ç¯å¢ƒå˜é‡é…ç½®**:
```bash
# .env.development
ENABLE_WX_CONTENT_CHECK=false  # å¼€å‘ç¯å¢ƒå…³é—­

# .env.production
ENABLE_WX_CONTENT_CHECK=true   # ç”Ÿäº§ç¯å¢ƒå¼€å¯
```

**é›†æˆç‚¹**:
- `PostService.createPost()` - å‘å¸ƒå¸–å­å‰æ£€æµ‹
- `CommentService.createComment()` - å‘å¸ƒè¯„è®ºå‰æ£€æµ‹
- `CircleService.createCircle()` - åˆ›å»ºåœˆå­åç§°/ç®€ä»‹æ£€æµ‹

**æœ¬åœ°æ•æ„Ÿè¯åº“**:
- ç»´æŠ¤ `src/common/data/sensitive-words.txt`
- ä½¿ç”¨ DFA (ç¡®å®šæœ‰é™è‡ªåŠ¨æœº) ç®—æ³•é«˜æ•ˆåŒ¹é…
- æ”¯æŒçƒ­æ›´æ–° (Redis ç¼“å­˜)

#### 6.0.2 OSS èµ„æºæ¸…ç†ç­–ç•¥ (Resource Cleanup)

**é—®é¢˜**: åˆ é™¤ Post/ActivityPhoto æ•°æ®åº“è®°å½•æ—¶ï¼ŒOSS ç‰©ç†æ–‡ä»¶ä¸ä¼šè‡ªåŠ¨åˆ é™¤ï¼Œé€ æˆå­˜å‚¨æµªè´¹ã€‚

**è§£å†³æ–¹æ¡ˆ**: å¼‚æ­¥äº‹ä»¶é©±åŠ¨æ¸…ç†

```typescript
// åˆ é™¤å¸–å­æ—¶å‘é€æ¸…ç†äº‹ä»¶
@Injectable()
export class PostService {
  async deletePost(postId: string) {
    const post = await this.prisma.post.findUnique({
      where: { id: postId },
      include: { images: true },
    });

    // 1. åˆ é™¤æ•°æ®åº“è®°å½• (çº§è”åˆ é™¤ PostImage)
    await this.prisma.post.delete({ where: { id: postId } });

    // 2. å‘é€å¼‚æ­¥æ¸…ç†äº‹ä»¶
    this.eventEmitter.emit('oss.cleanup', {
      urls: post.images.map(img => img.url),
    });
  }
}

// å¼‚æ­¥æ¸…ç†æ¶ˆè´¹è€…
@Injectable()
export class OssCleanupListener {
  @OnEvent('oss.cleanup')
  async handleCleanup(payload: { urls: string[] }) {
    for (const url of payload.urls) {
      try {
        await this.ossService.deleteObject(url);
      } catch (error) {
        // è®°å½•å¤±è´¥ï¼Œåç»­å®šæ—¶ä»»åŠ¡é‡è¯•
        await this.logFailedCleanup(url, error);
      }
    }
  }
}
```

**è¡¥å……æœºåˆ¶**:
- å®šæ—¶ä»»åŠ¡: æ¯æ—¥æ‰«æ `cleanup_failed` è¡¨ï¼Œé‡è¯•å¤±è´¥çš„åˆ é™¤
- ç›‘æ§å‘Šè­¦: OSS å­˜å‚¨å¢é•¿å¼‚å¸¸æ—¶å‘Šè­¦

**ä¼˜å…ˆçº§**: P2 (MVP åå®ç°ï¼Œå…ˆè®°å½• TECH-01 ä»»åŠ¡)

### 6.1 Feed æµç­–ç•¥

é‡‡ç”¨ **Pull æ¨¡å¼ + çƒ­ç‚¹ç¼“å­˜**:
1. ç”¨æˆ·è¯·æ±‚ Feed æ—¶å®æ—¶æŸ¥è¯¢
2. çƒ­é—¨å¸–å­ç¼“å­˜åˆ° Redis (TTL 5åˆ†é’Ÿ)
3. åˆ†é¡µé‡‡ç”¨ cursor-based è€Œé offset

```typescript
// FeedService ä¼ªä»£ç 
async getPersonalFeed(userId: string, cursor?: string) {
  const followingIds = await this.getFollowingIds(userId);
  return this.prisma.post.findMany({
    where: { userId: { in: followingIds } },
    orderBy: { createdAt: 'desc' },
    cursor: cursor ? { id: cursor } : undefined,
    take: 20,
  });
}
```

### 6.2 æˆå°±è§¦å‘æœºåˆ¶

```typescript
// achievement.listener.ts
@Injectable()
export class AchievementListener {
  @OnEvent('enrollment.checked_in')
  async handleCheckIn(payload: { userId: string; activityId: string }) {
    const count = await this.getCompletedActivityCount(payload.userId);
    if (count === 1) {
      await this.awardBadge(payload.userId, 'FIRST_HIKE');
    }
    if (count === 10) {
      await this.awardBadge(payload.userId, 'TRAIL_WALKER');
    }
  }
}
```

### 6.3 å›¾ç‰‡ä¸Šä¼ ç­–ç•¥

1. å‰ç«¯å‹ç¼© (max 1920px, quality 0.8)
2. ç›´ä¼  OSS (è·å–ä¸´æ—¶å‡­è¯)
3. ä¸Šä¼ æˆåŠŸåå›è°ƒåç«¯ä¿å­˜è®°å½•

---

## 7. éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
1. âœ… ç”¨æˆ·å¯å‘å¸ƒå›¾æ–‡åŠ¨æ€ï¼Œæ”¯æŒæœ€å¤š 9 å¼ å›¾ç‰‡
2. âœ… ç”¨æˆ·å¯å¯¹å¸–å­ç‚¹èµã€è¯„è®ºï¼Œè¯„è®ºæ”¯æŒå›å¤
3. âœ… ç”¨æˆ·å¯å…³æ³¨å…¶ä»–ç”¨æˆ·ï¼ŒæŸ¥çœ‹ç²‰ä¸/å…³æ³¨åˆ—è¡¨
4. âœ… ç”¨æˆ·å¯åŠ å…¥/åˆ›å»ºåœˆå­ï¼Œåœ¨åœˆå­å†…å‘å¸–
5. âœ… æ´»åŠ¨å®Œæˆåï¼Œå‚ä¸è€…å¯ä¸Šä¼ ç…§ç‰‡åˆ°æ´»åŠ¨ç›¸å†Œ
6. âœ… å®Œæˆç‰¹å®šæ¡ä»¶åï¼Œç”¨æˆ·è‡ªåŠ¨è·å¾—å¯¹åº”å‹‹ç« 
7. âœ… ä¸ªäººä¸­å¿ƒå±•ç¤ºç»Ÿè®¡æ•°æ®ã€å‹‹ç« å¢™ã€è¶³è¿¹åœ°å›¾

### æ€§èƒ½éªŒæ”¶
- Feed åŠ è½½æ—¶é—´ < 500ms
- å›¾ç‰‡ä¸Šä¼ æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- åˆ—è¡¨æ»šåŠ¨æµç•… (60fps)

---

## 8. é£é™©ä¸ç¼“è§£

| é£é™© | ç¼“è§£æªæ–½ |
|:---|:---|
| æ•°æ®åº“è¿ç§»å¤æ‚ | åˆ†æ‰¹è¿ç§»ï¼Œæ¯ä¸ªå­é˜¶æ®µç‹¬ç«‹è¿ç§» |
| å›¾ç‰‡å­˜å‚¨æˆæœ¬ | é™åˆ¶ä¸Šä¼ æ•°é‡ï¼Œå‰ç«¯å‹ç¼© |
| Feed æ€§èƒ½ç“¶é¢ˆ | Redis ç¼“å­˜ + cursor åˆ†é¡µ |
| ç”¨æˆ·æ´»è·ƒåº¦ä½ | ä¸æ´»åŠ¨ç³»ç»Ÿæ·±åº¦æ•´åˆï¼Œå®Œæˆæ´»åŠ¨åæç¤ºå‘å¸ƒåŠ¨æ€ |
